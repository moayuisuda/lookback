# Source Directory Agents

本目录包含 React 前端应用源码。

## 职责

- **UI 渲染**: 使用 React 构建用户界面。
- **状态管理**: 使用 `valtio` (`store.ts`) 管理全局状态（图片列表、画布状态、搜索词、Tag 排序）。
- **启动流程**: `main.tsx` 会在 React 挂载前先 hydrate i18n 与 settings（如 sidebarWidth / Gallery 抽屉状态），减少启动闪动并确保窗口状态可恢复；初始化 settings 使用批量接口减少请求次数。
- **快捷键管理**: 使用 `react-hotkeys-hook` 统一管理应用内快捷键，集中在 `hooks/useAppShortcuts.ts`。

- **组件结构**:
  - `components/Gallery.tsx`: 左侧瀑布流图片展示与搜索。
-    - 搜索逻辑：一次请求链路由「普通查询」+「可选翻译」+「向量查询」组成；普通查询先返回并渲染，向量结果异步合并且永远排在普通结果之后；请求会话使用 AbortController 隔离竞态，旧请求不会覆盖新请求状态。
    - 颜色过滤：支持选择颜色后按图片主体色近似过滤，并可与 Tag/文本组合。
    - 搜索输入：搜索条件变更后会重置分页并触发拉取，避免旧请求结果混入。
    - 默认展示：初始化与搜索统一为同一分页流程，先清空再追加。
    - 拖拽与粘贴：
      - 支持从 OS 拖拽文件到 Gallery，自动导入。
      - 支持从剪贴板粘贴图片或文件，统一导入 Gallery。
      - 导入的文件自动加入 Gallery。
      - **排序**:
        - 支持 Gallery 列表拖拽排序（`dnd-kit`）。
        - **持久化**: 拖拽排序后立即调用后端保存顺序，重启后保持用户自定义顺序。
        - **保鲜策略**: 新增图片（Paste/Drag）自动置顶，不受已有排序影响。
    - 视觉交互：
      - 图片 Hover 效果改为纯粹放大（Scale 1.05），去除阴影与 overflow-hidden，确保放大时突破容器边界并置于顶层（z-index）。
      - 标签展示：Hover 时在卡片底部渐变展示。
      - 响应式布局：Gallery 列数根据侧边栏宽度动态调整，拖动调整侧边栏宽度时，列数会自动增减（而不是单纯缩放）。
      - 焦点反馈：激活时显示 Teal 色边框高亮。
    - 右键菜单：
      - 功能增强：集成所有图片操作（打开链接、打开文件夹、Tag 管理、重新索引、删除）。
      - Tag 管理优化：采用统一的 Input 容器样式，集成展示已有 Tag 与输入框；输入时下方展示 Tag 建议（Focus 时显示），支持回车添加、Backspace 删除末尾 Tag。
      - 状态反馈：索引状态优化，仅在未索引（Non-indexed）时显示黄色圆点提示，已索引图片保持清爽无图标。
    - Tag 快捷搜索与管理：
      - 搜索框下方展示所有已有 Tag，点击即可快速填入并触发搜索。
      - Tag 排序：支持在搜索栏中直接拖拽 Tag 进行自定义排序，排序顺序持久化保存到本地存储。
    - Tag 组件化：封装通用 `Tag` 组件，统一 Tag 的展示、编辑、颜色指示器逻辑；支持通用 HTML 属性透传（ClassName, Event Handlers），应用于顶部筛选、卡片标签、右键菜单建议列表及色板标题。
    - 搜索功能增强：
      - 交互优化：右侧提供一键清空按钮；搜索框 X 按钮垂直居中对齐。
    - Tag 行为：导入时不自动附加默认 Tag，手动输入 Tag 时自动展示全局已有 Tag 下拉选项，支持点选复用；下拉选项采用 Flex Wrap 标签云布局。
    - 国际化：全界面英文展示。
    - 侧边栏：支持拖拽调整宽度（Resizable），宽度状态持久化。
    - 抽屉过渡：使用 translate3d + will-change 保持弹出动画流畅。
    - Pin Mode：全局固定模式常开，窗口置顶显示；画布区域在非穿透时显示 0.4 黑色背景，穿透时保持透明；不再提供 Pin 切换入口且不触发窗口宽度重计算。
  - `components/Canvas.tsx`: 右侧无限画布，支持拖拽、缩放、移动与自动布局。
    - 画布容器样式做了合并精简，保持透明/深色背景切换一致。
    - 数据持久化：画布内容通过 `localApi` 写入后端本地文件，图片优先以引用存储（关联 Gallery 图片 ID）。
    - **存储优化**: 保存时移除图片的冗余数据（如 `vector` 向量），仅保留必要引用与变换信息，显著减小 `canvas.json` 体积。
    - **引用策略**: 优先复用 Gallery 图片的本地路径引用，避免重复存储图片文件。
    - **临时文件管理**:
      - 删除画布图片或清空画布时，若为临时图片，立即请求后端物理删除文件。
    - 拖拽与粘贴：
      - 支持从 OS 拖拽文件到 Canvas，先导入 Gallery，再添加到 Canvas。
      - 支持从 Gallery 拖拽图片到 Canvas。
      - 支持右键拖拽平移画布（与空格+左键相同）。
    - **文本节点**:
      - 双击画布空白区域创建文本。
      - 双击文本节点进入编辑模式（Textarea Overlay）。
      - 支持左右调整宽度（无旋转），支持拖拽、删除、撤销。
      - 统一 State 管理（CanvasItem = Image | Text）。
    - 自动布局（Auto Layout）：
      - 采用 Masonry 布局算法（瀑布流），列数固定为 5，列间距 20px。
      - 排序逻辑：优先根据图片当前空间位置（Y 轴优先，X 轴次之）进行排序，再进行排布，以保留用户的视觉顺序。
      - 确保图片紧凑排列、互不重叠。
      - 重排仅改变位置，不改变图片当前缩放与旋转。
      - 即使图片尚未完全加载（无宽高信息），也具备默认占位处理。
    - 交互优化：
      - 操作模式：空格按下显示抓手，空格 + 鼠标拖拽平移画布；右键拖拽平移画布；左键拖动进行框选（Box Selection），支持 Shift/Ctrl 多选。
      - 焦点反馈：激活时显示 Theme Brand Color 边框高亮。
      - 清空按钮：左上角提供 Clear 按钮，一键清空画布（支持撤销）。
      - 多选拖拽：多选后拖拽任意选中图片，会联动移动所有选中图片。
      - 框选命中：在 Stage 坐标系下，将框选矩形与节点 `getClientRect({ relativeTo: stage })` 做相交判断，缩放/平移后仍能稳定选中多张。
      - 选中态：
        - 仅保留右下角缩放手柄和顶部旋转手柄，简化视觉干扰。
        - 顶部工具栏移除，功能直接集成在选中框上。
        - 右上角：删除按钮（固定大小 Icon）。
        - 左上角：水平翻转按钮（固定大小 Icon，仅翻转图片内容，不影响按钮与空间布局）。
        - 按钮大小恒定，不随图片缩放或画布 Zoom 变化；拖拽时实时跟随位置。
        - 删除/翻转/缩放按钮统一为共享组件与样式。
        - 多选时：额外显示整体包围框，右上角展示删除按钮，隐藏单图翻转与单图控制点。
        - 多选时：右下角提供矩形缩放控制点，拖拽缩放整组。
      - **层级管理**: 单击选中时自动置顶。
      - **历史记录**: 拖拽操作仅在结束时提交历史，过程使用 Transient Update，保证撤销/重做体验流畅。
    - 顶部工具栏：自动布局。
    - 键盘快捷键：Delete/Backspace 删除选中图片（已修复：在输入框内键入时不会误触删除）。
    - 撤销：Cmd/Ctrl + Z 回退上一步画布修改（移动/缩放/旋转/删除/自动布局）。
  - `components/TitleBar.tsx`: 自定义标题栏，包含窗口控制按钮；穿透模式下标题栏背景更浅，右侧空白区域支持鼠标穿透；穿透时隐藏设置与抽屉入口，保留 Ghost 与关闭按钮。
- **样式**: 使用 TailwindCSS 进行样式开发。
  - 主题色：统一在 `src/theme/index.ts` 中管理，禁止硬编码。核心品牌色为 #39C5BB (Teal/Turquoise)。
  - 滤镜激活态颜色使用主题色变量统一控制。

## 状态管理 (Valtio)

- `state`: 响应式代理对象，存储应用数据。
- `actions`: 修改 `state` 的函数集合（包含画布自动布局逻辑）。
- `useSnapshot`: 在组件中读取响应式状态。

## 交互能力概览

- 画布支持从左侧 Gallery 拖拽图片或点击添加，并自动布局排布。
- 画布支持从桌面直接拖入本地图片文件，先自动导入到 Gallery，再添加到画布。
- Gallery 支持从桌面直接拖入本地图片文件，自动导入。
- 支持全局粘贴操作，应用隐藏时不处理；Gallery 打开时导入到 Gallery，关闭时仅粘贴到 Canvas。
- 画布内容自动持久化，重启应用后恢复。
- 应用默认处于 Pin 模式，窗口置顶显示，背景保持透明。
- 穿透模式在 Canvas 内显示右上/右下/左下圆角直角定位标记。
