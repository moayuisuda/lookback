# Electron Directory Agents

本目录包含 Electron 主进程相关代码。

## 职责
- **Main Process (`main.ts`)**: 
    - 创建和管理应用窗口 (`BrowserWindow`)。
    - 启动本地 Express 服务器 (`startServer`)，用于接收来自浏览器插件的收藏请求。
    - 处理 IPC 通信（窗口控制、总是置顶、透明模式、存储目录选择等）。
    - 管理本地文件存储（图片下载、元数据保存），导入时不再自动附加默认标签。
    - 支持通过 `lookback_config.json` 配置图片根目录，仅在元数据中持久化文件名，运行时按当前根目录拼接本地路径和访问 URL。
    - **文件保存策略优化**：
        - 文件名：优先使用 URL 原始文件名（去除 Query 参数），若无扩展名则默认 `.jpg`。
        - 去除时间戳前缀，仅在重名时追加 `_1`, `_2` 等后缀。
15→        - 标题处理：自动过滤无效的 "Document" 标题，避免干扰。
16→        - 存储结构：图片统一保存在 `images/` 子目录下，前端通过相对路径生成本地访问 URL。
    - **向量服务 (`PythonVectorService`)**: 管理一个常驻的 Python 子进程（`server/python/tagger.py`），通过标准输入输出流（stdio）进行通信。该服务负责加载 CLIP 模型并快速生成图片和文本的向量，避免了重复加载模型的开销。支持请求队列，确保并发请求有序处理。
    - **模型校验与下载**: 应用启动后校验 storage 根目录下 `model/` 完整性；缺失时强制触发下载并通过 IPC 发送进度事件给渲染进程，由渲染进程展示全局下载进度弹窗（`ModelDownloadModal`），支持大权重文件的字节级进度展示。
    - **启动流程**: 优先加载渲染进程窗口，随即启动 API 服务，最后进行模型环境检查与下载，确保 UI 能及时响应下载进度事件。
    - **快捷键**: 支持可配置的全局快捷键（默认 Cmd/Ctrl + L），用于隐藏/展示主窗口；可在设置中修改并热更新注册。
17→    - **API 服务**: 提供 RESTful API 供前端调用，包括图片搜索（支持文本或向量输入）、删除、更新标签、重新索引、打开图片所在文件夹等。
     - **Canvas 保存优化**: 保存 Canvas 数据时，自动扫描并清理 `canvas_temp` 目录中未被引用的临时文件，防止垃圾文件堆积。
     - **临时文件即时清理**: 提供 `/api/delete-temp-file` 接口，支持前端在删除画布元素时立即清理对应的临时文件。
     - **临时文件命名优化**: `/api/upload-temp` 支持自定义文件名，优先使用原始文件名（经安全处理），仅在必要时附加时间戳。
    - **画廊排序持久化**: 
        - 引入 `gallery_order.json` 存储用户自定义的图片顺序（ID 列表）。
        - `/api/save-gallery-order`: 提供接口保存当前的图片 ID 顺序。
        - `/api/images`: 读取持久化的顺序文件，并按照“保鲜”原则排序：未在顺序表中的新图片优先展示（排在最前），已排序的图片按顺序表排列，最后是其他图片按创建时间倒序。
- **Preload Script (`preload.ts`)**: 
    - 作为主进程和渲染进程之间的桥梁。
    - 通过 `contextBridge` 安全地暴露部分 API 给渲染进程。
    - 提供 `openExternal` 能力，将外链交给系统默认浏览器打开（用于避免在 Electron 新窗口里丢失浏览器登录态）。
    - 通过事件推送支持“先快后慢”的搜索结果更新（`search-updated`）。
- **日志系统**: 
    - 使用 `electron-log` 记录应用运行时的关键信息和错误。
    - 记录内容包括：应用启动流程、文件加载路径、模型初始化状态、API 服务启动状态、渲染进程加载状态（成功/失败/崩溃）等。
    - 日志文件默认存储在操作系统的标准日志目录下（如 macOS 的 `~/Library/Logs/app/main.log`）。

## 搜索匹配规则
搜索功能采用 Tag 过滤 + 向量相似度的混合策略，支持“Tag 严格匹配 + 自然语言”组合搜索。

1. **Tag 过滤（可选）**
   - 若请求包含 `tags`（字符串数组），先在全量图片中做严格过滤（AND）：结果必须同时包含所有请求 Tag。
   - 该步骤用于实现“先 Tag 严格匹配，再在结果内做语义检索”。

2. **查询向量生成（可选）**
   - 若请求包含 `vector`（以图搜图），直接使用该向量作为查询向量。
   - 否则当 `query` 非空时，调用 Python 服务将文本编码为向量。

3. **Tag 文本匹配（可选，纯文本时优先）**
   - 当未提供 `tags` 过滤且 `query` 非空时，会检查图片 Tag 是否“包含”查询词（大小写不敏感）。
   - 命中时赋予固定高分 `2.0`（用于优先返回显式 Tag 命中结果）。

4. **语义向量匹配**
   - 如果 Python 服务可用且生成了查询向量，则计算查询向量与图片向量的点积（Cosine Similarity）。
   - 若向量相似度高于当前分数，则以向量得分覆盖。

5. **阈值与排序**
   - 无 `tags` 过滤时：过滤得分 ≤ 0.15 的结果，并按得分降序。
   - 有 `tags` 过滤时：返回过滤后的全量候选集；若存在向量则按向量得分降序（相同得分按创建时间降序），否则按创建时间降序。

## 构建
- 使用 `tsup` 编译为 CommonJS 格式输出到 `dist-electron` 目录。
